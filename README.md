# BIOS Sledgehammer
Automated BIOS update, TPM firmware update and BIOS settings for HP devices.


```
            _
    jgs   ./ |   BIOS Sledgehammer 
         /  /      
       /'  /       
      /   /      https://github.com/texhex/BiosSledgehammer
     /    \      
    |      ``\     
    |        |                                ___________________
    |        |___________________...-------'''- - -  =- - =  - = `.
   /|        |                   \-  =  = -  -= - =  - =-   =  - =|
  ( |        |                    |= -= - = - = - = - =--= = - = =|
   \|        |___________________/- = - -= =_- =_-=_- -=_=-=_=_= -|
    |        |                   `` -------...___________________.'
    |________|      
      \    /     
      |    |     This is *NOT* an official HP tool.                         
    ,-'    `-,   This is *NOT* sponsored or endorsed by HP.
    |        |   Use at your own risk. 
    `--------'    

```

## Disclaimer 

* BIOS Sledgehammer is **NOT** an official HP tool.                         
* This is **NOT** sponsored or endorsed by HP.
* HP was **NOT** involved in developing BIOS Sledgehammer.
* You computer can become [FUBAR](https://en.wikipedia.org/wiki/List_of_military_slang_terms#FUBAR) in the process. 

## About

## System requirements

* Windows 7 or Windows 10 - Windows 8 should also work, but wasn't tested
* 64-bit Operating System
* PowerShell 4.0 or higher
* [HP BIOS Configuation Utility](https://ftp.hp.com/pub/caps-softpaq/cmit/HP_BCU.html) (BCU) 4.0.15.1 stored in the folder ``\BCU-4.0.15.1``
* [BIOS Update](http://www.hp.com/drivers) files for the models you want to support
* [TPM Update files](http://h20564.www2.hp.com/hpsc/doc/public/display?docId=emr_na-c05192291) (Advisory with download link) if a TPM update is desired - (Also: [TPM 1.2 vs. 2.0](http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11849.tpm-1-2-vs-2-0-features)) 

## Process

When starting BiosSledgehammer.ps1, the following will happen:

* A log file ``BiosSledgehammer.ps1.log-XX.txt`` is created, where XX is sequentially increased value with each run. See [Logfile](#logfile) for details.
* It checks if the environment is ready (64-bit OS, required folders found, device is from HP etc.).
* A check is made if communication between BCU (BiosConfigUtility64.exe) and the BIOS through WMI is possible by reading the value of *Universally Unique Identifier (UUID)*.
* It tries to figure out the password the device is using by going through all files in the [PwdFiles folder](#pwdfilesfolder) and trying to change the value of *Asset Tracking Number* to a random value (it will be reverted to the original value at the end). An empty password is already tried first. 
* A search is performed below the [Models folder](#modelsfolder) to locate the matching folder for the current model (this is a partial search, so a sub folder named *1040 G1* will match the model *HP EliteBook Folio 1040 G1*). All configuration is then read from this folder only. 
* If a file called **BIOS-Update.txt** is found, it is read and checked if a BIOS update is required. If so, the BIOS update files are locally copied and the update is performed. Any **.log* file generated by the update tool is attached to the BIOS Sledgehammer log file.  Finally, a restart is requested because the actual update is performed during POST. See [BIOS Update](#biosupdate) for more details.
* If a file called **TPM-Update.txt** exists, it is read and checked if a TPM update is required. This is done by checking if the TPM Specification version (1.2 or 2.0) or the TPM firmware are below the configured versions. If so, the TPM updates files are locally copied and executed. Any **.log* file generated by the update tool is attached to the BIOS Sledgehammer log file.  Finally, a restart is requested because the actual update is performed during POST. See [TPM Update](#tpmupdate) for more details.
* If a file called **BIOS-Password.txt** is found, it is checked if the device is already set to use this password. The password is not specified directly (clear), but using a *.bin file name that stores the password encrypted. If the passwords differ, the configured *.bin file is read from the [PwdFiles folder](#pwdfilesfolder) and the password is changed. See [BIOS Password](#biospassword) for more details.
* If a file called **BIOS-Settings.txt** exists, it is read and each entry is the name of a BIOS setting that needs to be changed. Each entry will be performed as single change (not all in a batch) to detect faulty settings more easily. See [BIOS Settings](#biossettings) for more details.

## Configuration files format

BIOS Sledgehammer uses several configuration files that all follow the same ``NAME==VALUE`` syntax. There are saved as *.txt files to make it easier to change them directly with a text editor. 

```
# This is a comment and ignored
; So is this line. 
#And this.
;And this also.

# The general format is NAME==VALUE
Version==1.08

# Leading or trailing white spaces are ignored so this is the same as the line before
 Version == 1.08
```

## <a name="logfile">Logfile</a>

Each time BIOS Sledgehammer is executed, a new logfile with the pattern ``BiosSledgehammer.ps1.log-XX.txt`` is created - ``XX`` is sequentially increased so the first run can be found in ``BiosSledgehammer.ps1.log-01.txt``, the second run in ``BiosSledgehammer.ps1.log-02.txt`` and so on. The location where these files are stored depends on if MDT/SCCM is active.

If the script is not executed in a task sequence (by MDT or SCCM), the logfile is saved to  ``C:\Windows\Temp\``.

If MDT or SCCM are activate the task sequence variable ``LogPath`` is used: ``C:\MININT\SMSOSD\OSDLOGS\`` or ``C:\Windows\Temp\DeploymentLogs\``.


## <a name="pwdfilesfolder">*PwdFiles* folder</a>

The ``\PwdFiles`` folder stores all BIOS passwords that your device might use. When BIOS Sledgehammer starts, it tries every file in this folder until the password for the device has been found. If no password file matches, an error is generated. An empty password is automatically added to the this list, there is no file for this.

The order, in which they are tried, is determined by sorting the files by name: a file called *01_Standard.bin* is tried before *02_Standard2.bin*. The most commonly used password should always come first because some BIOS versions enforce how many times you can try a wrong BIOS password. When this limit is reached, any password is rejected until the computer is restarted. 

To create these files, execute ``HPQPswd64.exe`` (found in the BCU folder) and save the file (extension *.bin) to this folder. 


## <a name="modelsfolder">*Models* folder</a>

It is expected that each model (type) of hardware you want to support, requires a separate sub folder below ``\Models``. The model (type) is displayed automatically by BIOS Sledgehammer, so simply run it once for each hardware to know the model for it. 

The sub folder will contain all settings files together with the source files for any updates. Please note that BIOS Sledgehammer does not support “sharing” update files between several models, each model requires its own set of files. That’s because sharing files between models has proven to cause problems for older models each time the shared folders are updated for new models. 

To locate the model folder, a partial search with the current model is used. If you execute it on a ``HP EliteBook Folio 1040 G1``, the folder can be called exactly like that, or, if you are lazy, ``1040 G1``. 

If you do not want to change anything for a given model, simply create an empty folder. If no model folder at all is found, an error is generated. 

## <a name="biosupdate">BIOS Update</a>

The settings for a BIOS update need to be stored in the file ``BIOS-Update.txt`` for the given model. For example, if you execute it on a *HP EliteBook 850 G1* and the model folder is called *\Models\HP EliteBook 850 G1\*, the entire file path is *\Models\HP EliteBook 850 G1\BIOS-Update.txt*. Here is an example file for this device:

```
# 850 G1 BIOS Update

#The BIOS version the device should have
Version == 1.37

#Command to be executed for the BIOS update
Command==HPBiosUpdRec64.exe 

#Arguments to pass to COMMAND

# Silent
Arg1 == -s
# Do not restart automatically
Arg2 == -r
# Disable BitLocker during upgrade
Arg3 == -b
# Password file (parameter will be removed if device has no BIOS password)
Arg4 == -p"@@PASSWORD_FILE@@"
```
**Note**: BIOS Sledgehammer enforces that the source files are stored in a sub folder called ``BIOS-VERSION``. If the desired BIOS version is 1.37, the BIOS files need to be stored in ``\BIOS-1.37\``. Given that the current model folder is ``\Models\HP EliteBook 850 G1``, the entire path would be ``\Models\HP EliteBook 850 G1\BIOS-1.37``. 

The source folder is then copied to %TEMP% (to avoid any network issues) and the process is started from there. Because the update utility sometimes restarts itself, it is waited until the process noted in COMMAND does no longer appear as running process. If any **.log* file was generated in the local folder, this content is added to the normal BIOS Sledgehammer log. A restart is requested after that because the “real” update process happens during POST, after the restart. 

If anything goes wrong during the process, an error is generated. 

## <a name="tpmupdate">TPM Update</a>

The settings for a TPM update need to be stored in the file ``TPM-Update.txt`` for the given model. For example, if you execute it on a *HP EliteBook Folio 1040 G3* and the model folder is called *\Models\HP EliteBook Folio 1040 G3\*, the entire file path is *\Models\HP EliteBook Folio 1040 G3\TPM-Update.txt*. Here is an example file for this device:

```
# 1040 G3 TPM Update

# Manufacturer of the TPM. 
# If the value exists, the device must have this vendor or no update takes place
Manufacturer == 1229346816
#1229346816 is IFX

# The TPM Spec version we want this this device to have
SpecVersion == 2.0

# The Firmware version we want this device to have 
FirmwareVersion == 7.41

# Define the upgrade file to be used for each firmware
# The firmware active on the device must match an entry here or no upgrade can be performed
6.40 == Firmware\TPM12_6.40.190.0_to_TPM20_7.41.2375.0.BIN
6.41 == Firmware\TPM12_6.41.197.0_to_TPM20_7.41.2375.0.BIN
7.40 == Firmware\TPM20_7.40.2098.0_to_TPM20_7.41.2375.0.BIN

# Command to be used to perform the TPM firmware upgrade
Command == TPMConfig64.exe

#Arguments passed to COMMAND
Arg1 == -s
Arg2 == -f"@@FIRMWARE_FILE@@"
Arg3 == -p"@@PASSWORD_FILE@@"
```
The first setting **Manufacturer** is optional and can be used to ensure that the TPM firmware vendor for the device matches the update files. If not defined, the TPM firmware vendor is ignored. To detect if an TPM update is required, two versions need to be checked: The TPM Specification version (**SpecVersion**) and the firmware version (**FirmwareVersion**). 

The reason is that all TPM firmware is developed by 3rd parties so a change from TPM 1.2 to 2.0 can result in a LOWER firmware version when the vendor is changed (see [this article on the Dell wiki]( http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11850.how-to-change-tpm-modes-1-2-2-0) – TPM Spec 1.2 is firmware 5.81 from WEC, TPM Spec 2.0 is firmware 1.3 from NTC). BIOS Sledgehammer checks both versions and if any of those two are higher than the current system reports, a TPM update is required. 

The current TPM firmware version of the device is retrieved and it is checked if the settings file contains an entry for this firmware version. Given that the current device has TPM firmware 6.40, the update can be performed as an entry for this version exists (**6.40 == Firmware\TPM12....**). However, if the system would have firmware 6.22 the update would fail because no entry for this version exists. 

Because a TPM update also requires that BitLocker is completely turned off (as any BitLocker keys are lost during the upgrade), BIOS Sledgehammer will check if the system drive is encrypted with BitLocker and starts an automatic decryption before executing the update. This works for Windows 10, but in Windows 7 you need to decrypt the drive yourself. 

Once this is all set and done, the source folder is copied to %TEMP% (to avoid any network issues) and the process is started from there.

**Note**: BIOS Sledgehammer enforces that the source files are stored in a sub folder called ``TPM-VERSION``. If the desired TPM firmware version is 7.41, the TPM files need to be stored in ``\TPM-7.41\``. Given that the current model folder is ``\Models\HP EliteBook Folio 1040 G3``, the entire path would be ``\Models\HP EliteBook Folio 1040 G3\TPM-7.41``. 

Because the update utility sometimes restarts itself, it is waited until the process noted in COMMAND does no longer appear as running process. If any **.log* file was generated in the local folder, this content is added to the normal BIOS Sledgehammer log. A restart is requested after that because the “real” update process happens during POST, after the restart. 

If anything goes wrong during the process, an error is generated. 


## <a name="biospassword">BIOS Password</a>

The set a BIOS password, you define the password file (containing the desired password) in ``BIOS-Password.txt``. For example, if you execute it on a *HP EliteBook 850 G1* and the model folder is called *\Models\HP EliteBook 850 G1\*, the entire file path is *\Models\HP EliteBook 850 G1\BIOS-Password.txt*. Here is an example file for this device:

```
# Use our standard password
PasswordFile == 01_W2f4x7t8NxD4xUH.bin
```
**IMPORTANT**: This is insecure and just an example! Do not use the password itself as file name!   

This file has to be stored in the [PwdFiles folder](#pwdfilesfolder) (see this section how to create the files).
If you want to use an empty password, just leave the value empty like this:
```
PasswordFile == 
```
Regarding BIOS passwords, please note the following:
* On some devices, some BIOS settings, e.g. TPM Activation Policy on a 2570p, require a password to be set or they can’t be activated (BCU fails with error 32769)
* Passwords need to meet minimum complexity rules (must contain upper and lower case letters and a number) or the password change will simply not work without any specific error message
* There is only some password changes allowed per power cycle. If the password change just doesn’t work although it has worked before, turn the device off and on.



## TODO
## TODO 
## TODO 
## TODO 
## TODO 
## TODO
## TODO 
## TODO 
## TODO 
  
## TPM Information

* [Dell: TPM 1.2 vs. 2.0 Features](http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11849.tpm-1-2-vs-2-0-features)
* [Dell: Get TPM information using PowerShell](http://en.community.dell.com/techcenter/b/techcenter/archive/2015/12/09/retrieve-trusted-platform-module-tpm-version-information-using-powershell)
* [Dell: How to change TPM Modes](http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11850.how-to-change-tpm-modes-1-2-2-0)
* 



http://chris.com/ascii/index.php?art=objects/tools

## Using from MDT or SCCM

By default, MDT will run all scripts hidden in order to hide any sensitive information displayed. If you are okay with that, just run ``BiosSledgehammer.ps1`` as PowerShell scripts but remember to tick the box for "Disable 64bit file system redirection" so it is run as 64-bit PowerShell process (this settings is only for SCCM - MDT always runs PowerShell native).

If you want to see what BIOS Sledgehammer is doing, run the provided batch file ``RunVisble.bat`` from MDT with this command line: ``cmd.exe /c "%SCRIPTROOT%\BiosSledgehammer\RunVisible.bat"`` (given you stored it in the *\Scripts* folder). 

This batch automatically uses the correct version of PowerShell, so no box to check for this. It will also set the ``-WaitAtEnd`` parameter which causes BIOS Sledgehammer to pause for 30 seconds when finished so you can have a quick look at the results. 
  


## Contributions
Any constructive contribution is very welcome! If you encounter a bug or have an addition, please create a [new issue](https://github.com/texhex/BiosSledgehammer/issues/new).

## License
Copyright © 2016 [Michael Hex](http://www.texhex.info/). Licensed under the **Apache 2 License**. For details, please see LICENSE.txt.



## TODO
* In case BCU returns the code 32769 it can mean two things:
  * This setting can not be set without a BIOS password beeing in place (TPM Activation Policy for example)
  * This setting would result in damage to the current systen (Secure Boot enabled when running this script from Windows 7)
* BIOS passwords need to meet minimum complexity rules. If the password stored in a *.bin file does not meet this rules, the password change will fail. Make sure your password contains uppercase and lowercase letter, together with at least one number.
*  #HPBiosUpdRec64.exe might restart itself as a service in order to perform the update...        

    More about TPM Data:
    http://en.community.dell.com/techcenter/b/techcenter/archive/2015/12/09/retrieve-trusted-platform-module-tpm-version-information-using-powershell
    http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11850.how-to-change-tpm-modes-1-2-2-0
    http://www.dell.com/support/article/de/de/debsdt1/SLN300906/en
    http://h20564.www2.hp.com/hpsc/doc/public/display?docId=emr_na-c05192291
  #>

  * Dell:
  *   ID 1314145024 = NTC with Version 1.3 = TPM 2.0
  *   ID 1464156928 = WEC with Version 5.81 = TPM 1.2
  * HP:
  *   ID 1229346816 = IFX with Version 4.32 = TPM 1.2
  *

* TPM Update: Check Manufacturer ID  
* TPM Update starts if either the TPM SpecVersion **OR** the firmware is below the defined values
* TPM Update: BitLocker for C: and BitLocker module available will cause a full decryption
* Log file are either in C:\Windows\Temp\BiosSledgehammer.ps1.log-XX.txt or in the path your MDT/SCCM defines as ``LogPath`` (typical *C:\MININT\SMSOSD\OSDLOGS* or when it's finished *C:\Windows\Temp\DeploymentLogs\*)
  
BIOS Updates:
  http://www.hp.com/drivers


  
Download:
  ftp://ftp.hp.com/pub/softpaq/sp76001-76500/sp76423.html

* zz_GetAllBiosSettings.bat

* If a restart is requested, the script will set the return code (exit code) to 3010 (ERROR_SUCCESS_REBOOT_REQUIRED)